<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Leigh Perry's Blog - Design of a Configuration Library</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="alternate" type="application/rss+xml" title="Leigh Perry's blog" href="./feed.xml">
        <link rel="alternate" type="application/atom+xml" title="Leigh Perry's blog" href="./atom.xml">
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Leigh Perry's Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Design of a Configuration Library</h1>

            <div class="info">
    Posted on September  1, 2019
    
</div>

<p>As a rule of thumb, there is a configuration library for every five developers (and a logging library for every two). This blog is about my configuration library, called <a href="https://github.com/leigh-perry/conduction">Conduction</a>.</p>
<h1 id="justification">Justification</h1>
<p>Why write another configuration library? Well, in the age of containerised cloud deployments, programs usually need to read their configuration from environment variables. But they need to read that configuration into rich data structures, such as:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb1-1" title="1">  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">AppConfig</span>(</a>
<a class="sourceLine" id="cb1-2" title="2">    appName: String,</a>
<a class="sourceLine" id="cb1-3" title="3">    endpoint: Endpoint,</a>
<a class="sourceLine" id="cb1-4" title="4">    role: Option[AppRole],</a>
<a class="sourceLine" id="cb1-5" title="5">    intermediates: List[TwoEndpoints],</a>
<a class="sourceLine" id="cb1-6" title="6">  )</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">Endpoint</span>(host: String, port: Int)</a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">TwoEndpoints</span>(ep1: Endpoint, ep2: Endpoint)</a>
<a class="sourceLine" id="cb1-10" title="10"></a>
<a class="sourceLine" id="cb1-11" title="11">  <span class="co">// A String newtype</span></a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="kw">final</span> <span class="kw">case</span> <span class="kw">class</span> <span class="fu">AppRole</span>(value: String) <span class="kw">extends</span> AnyVal</a></code></pre></div>
<p>I wanted to be able to, in one step, read the configuration from a set of environment variables like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="bu">export</span> <span class="va">MYAPP_APP_NAME=</span>someAppName</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="bu">export</span> <span class="va">MYAPP_ENDPOINT_HOST=</span>12.23.34.45</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="bu">export</span> <span class="va">MYAPP_ENDPOINT_PORT=</span>6789</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="bu">export</span> <span class="va">MYAPP_ROLE_OPT=</span>somerole</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_COUNT=</span>2</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_0_EP1_HOST=</span>11.11.11.11</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_0_EP1_PORT=</span>6790</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_0_EP2_HOST=</span>22.22.22.22</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_0_EP2_PORT=</span>6791</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_1_EP1_HOST=</span>33.33.33.33</a>
<a class="sourceLine" id="cb2-11" title="11"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_1_EP1_PORT=</span>6792</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_1_EP2_HOST=</span>44.44.44.44</a>
<a class="sourceLine" id="cb2-13" title="13"><span class="bu">export</span> <span class="va">MYAPP_INTERMEDIATE_1_EP2_PORT=</span>6793</a></code></pre></div>
<p>into an instance of <code>AppConfig</code>.</p>
<p>Conduction is the library that lets me do that, via:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb3-1" title="1">      Configured[IO, AppConfig]</a>
<a class="sourceLine" id="cb3-2" title="2">        .<span class="fu">value</span>(<span class="st">&quot;MYAPP&quot;</span>)</a>
<a class="sourceLine" id="cb3-3" title="3">        .<span class="fu">run</span>(Environment.<span class="fu">fromEnvVars</span>)</a></code></pre></div>
<p>You can read more over at the Conduction <a href="https://github.com/leigh-perry/conduction/blob/master/README.md">documentation page</a>.</p>
<h1 id="aims">Aims</h1>
<p>In writing the library, I had some ambitions.</p>
<ul>
<li>I wanted it to be pure-functional.</li>
<li>Extensibility. Allow the user to
<ul>
<li>add new primitive types,</li>
<li>add new complex types,</li>
<li>add other <em>effects</em> beyond <code>Option</code>, <code>List</code>, <code>Either</code>, etc.</li>
<li>add new ways of providing the configuration, beyond just environment variables or JVM system properties.</li>
</ul></li>
<li>Provide complete validation. If there are multiple configuration errors, report them all rather than bailing at the first.</li>
</ul>
<h1 id="implementation">Implementation</h1>
<p>It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English.</p>
<h2 id="first-cut">First cut</h2>
<p>It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English.</p>
<h2 id="factoring-out-the-conversion">Factoring out the Conversion</h2>
<p>It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English.</p>
<h2 id="moving-to-reader-monad">Moving to Reader monad</h2>
<p>It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English.</p>
<h1 id="looking-back">Looking back</h1>
<p>It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout. The point of using Lorem Ipsum is that it has a more-or-less normal distribution of letters, as opposed to using ‘Content here, content here’, making it look like readable English. Many desktop publishing packages and web page editors now use Lorem Ipsum as their default model text, and a search for ‘lorem ipsum’ will uncover many web sites still in their infancy. Various versions have evolved over the years, sometimes by accident, sometimes on purpose (injected humour and the like).</p>

        </div>
        <div id="footer">
            Site created with <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
